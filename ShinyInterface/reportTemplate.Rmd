---
title: "FitOCT Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    fig_height: 5
    fig_width: 10
    number_sections: yes
    theme: cerulean
  pdf_document:
    fig_height: 5
    fig_width: 7
    number_sections: yes
  word_document:
    fig_height: 5
    fig_width: 10
    number_sections: yes
    toc: TRUE
fontsize: 11pt
---

```{r, results='asis', echo=FALSE}
# knitr global options
knitr::opts_chunk$set(comment = NA)

# Graphical params
cex=1
mar=c(4,4,2,1)
mgp=c(2,.75,0)
pty='s'
tcl=-0.5
scale = 0.5 # for multiplots
```

# Parameters

```{r, echo=FALSE, results='hold'}
cat('File name :',input$dataFile[['name']],'\n')
cat('\n')
cat('Configuration Parameters\n')
cat('------------------------\n')
str(listCtrlParams(),give.head=FALSE, give.length=FALSE)

C = selX(Inputs$x,Inputs$y,input$depthSel,input$subSample)
```


# Noise estimation

## Optimal parameters

```{r, echo=FALSE, results='hold'}
out = Inputs$outSmooth
if(!is.null(out)) {
  summaryNoise(out) 
}
```


```{r, echo = FALSE}
if(!is.null(out)) {
  plotNoise(
    x=C$x, y=C$y, uy=out$uy, ySmooth=out$ySmooth
  )
}
```

# Monoexponential fit

## Fit validation

```{r, echo=FALSE, results='hold'}
outm = Inputs$outMonoExp
if(!is.null(outm)) {

  fit  = outm$fit
  if(outm$method == 'optim') {
    br = fit$par$br
  } else {
    br = mean(extract(fit,pars='br')[[1]])
  }
  
  # Probability Interval for Birge's ratio
  printBr(br, N = length(C$x), Np = 3)
}
```

## Optimal parameters

```{r, echo=FALSE, results='hold'}
if(!is.null(outm)) {
  summaryMonoExp(outm) 
}
```


```{r, echo = FALSE}
if(!is.null(outm)) {
  plotMonoExp(
    x=C$x, y=C$y, uy=out$uy, ySmooth=out$ySmooth,
    mod=outm$fit$par$m, resid=outm$fit$par$resid
  )
}
```


# Modulated exponential fit

## Fit validation

```{r, echo=FALSE, results='hold'}
outg = Inputs$outExpGP
if(!is.null(outg)) {
  cat('Modulated-exponential model best params\n')
  cat('---------------------------------------\n')
  
  fit = outg$fit
  if(outg$method == 'optim') {
    br = fit$par$br
  } else {
    br = mean(extract(fit,pars='br')[[1]])
  }
  
  # Probability Interval for Birge's ratio
  printBr(br, N = length(C$x), Np = 5,
          Nn = input$Nn, nz = nzCtrlPts(0.9)
  )
}
```

## Optimal parameters

```{r, echo=FALSE, results='hold'}
if(!is.null(outg)) {
  summaryExpGP(outg)  
}
```


```{r, echo = FALSE, fig.height=10}
if(!is.null(outg)) {
  plotExpGP(
    x=C$x, y=C$y, uy=out$uy, ySmooth=out$ySmooth,
    out=outg, modScale=input$modRange
  )
}
```

# Appendices

## Diagnostics for Modulated exponential fit

```{r, echo = FALSE, fig.height=10}
if(!is.null(outg)) {
  if (outg$method != 'optim') {
    fit  = outg$fit
    pars = c('theta','yGP','lambda','sigma','br')
    print(rstan::traceplot(fit, inc_warmup=TRUE, pars = pars))
  }
}
```

## Prior pdf for Modulated exponential fit

### Prior parameters statistics

```{r, echo=FALSE, results='hold'}
outp = Inputs$outPriExpGP
if(!is.null(outp)) {
  summaryPriExpGP(outp)  
}
```

### Predictive prior

```{r, echo = FALSE}
if(!is.null(outp)) {
  plotExpGP(
    x=C$x, y=C$y, uy=out$uy, ySmooth=out$ySmooth,
    out=outp, modScale=input$modRange
  )
}
```

### Prior parameters traces

```{r, echo = FALSE, fig.height=10}
if(!is.null(outp)) {
  fit  = outp$fit
  pars = c('theta','yGP','lambda','sigma')
  print(rstan::traceplot(fit, inc_warmup=TRUE, pars = pars))
}
```


### Prior vs. posterior marginal pdfs

```{r, echo = FALSE, fig.height=10}
if(!is.null(outp) & !is.null(outg)) {
  if (outg$method != 'optim') {
    plotPriPosAll(outp,outg)
  }
}
```


******

# Session Info

```{r, echo=FALSE}
sessionInfo()
```
